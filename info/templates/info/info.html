{% extends 'report/base.html' %}
{% load static %}
{% block extra-style %}
<!-- jQuery 라이브러리 로드 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="http://code.jquery.com/jquery-1.11.0.js"></script>
<style>
    p {
      font-size: 1rem; /* 1rem = 16px */
    }
    .content {
        position: relative;
        top: 15vh;
        height: fit-content;
        width: 100%;
        padding-top: 2vh;
        padding-bottom: 20px;
    }
    #map {
        width: 100%;
        min-height: 75vh;
        height: 100%;
        position: relative;
        margin: 0 auto;
        display:flex;
        align-content: center;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 5px;
    }
    table th {
      background-color: #f8f8f8;
      color: #333;
      padding: 10px;
      text-align: 10px;
      border-bottom: 2px solid #ddd;
      font-size: 0.9rem;
    }
    table td {
      padding: 10px; /* 셀 안쪽 여백 */
      border-bottom: 1px solid #ddd; /* 아래 테두리 */
      font-size: 0.75rem;
    }
    .icon p {
      font-size: 0.75rem;
    }
    .icon img {
      width: 20px;
      height: 20px;
      margin-left: 5px;
    }
    .table-container {
        order: 1;
    }

    .map-container {
        order: 2;
    }
    /* 반응형 스타일 */
    @media (max-width: 768px) {
        .row {
            flex-direction: column-reverse; /* 열을 반전하여 지도 아래로 이동 */
        }

        #map {
            max-height: 40vh;
        }
    }

</style>
{% endblock %}

{% block main_area %}
<div class="content">
  <div class="row">
    <div class="col-12 col-md-8 map-container">
      <div id="map">
      </div>
    </div>
    <div class="col-12 col-md-4 table-container">
      <div class="icon d-flex justify-content-end">
        <p style="margin-bottom: 5px;">
           <img src="{% static '/image/warning1.png' %}" alt="circle">1순위
           <img src="{% static '/image/caution1.png' %}" alt="circle">2순위
           <img src="{% static '/image/intend1.png' %}" alt="circle">그 외
        </p>
      </div>
        <p class="text-end" style="font-size: 0.75rem; margin-bottom: 0;">각 우선순위를 누르면 해당 위치로 움직이고</p>
        <p class="text-end" style="font-size: 0.75rem; margin-bottom: 0;"> 링크 ID를 누를 시 자세한 정보가 나옵니다.</p>
      <table>
        <tr>
          <th>우선순위</th>
          <th>링크ID</th>
          <th>균열 타입</th>
          <th>교통량</th>
          <th>등록일자</th>
        </tr>
        {% for instance in object_list %}
        <tr>
            <td><a href="#" class="priority-link" data-lat="{{instance.report.latitude}}" data-lng="{{instance.report.longitude}}">
              {{instance.priority}}</a>
            </td>
            <td><a href="{% url 'info:detail' instance.report.id %}">
              {{instance.link_id}} </a>
            </td>
            <td>{{instance.type}}</td>
            <td>{{instance.traffic}}</td>
            <td>{{instance.date}}</td>
        </tr>
        {% endfor %}
      </table>
      <div class="pagination">
        <span class="step-links">
            {% if page_obj.has_previous %}
                <a href="?page=1" style="font-size: 0.75rem;">&laquo; 처음</a>
                <a href="?page={{ page_obj.previous_page_number }}" style="font-size: 0.75rem;">이전</a>
            {% endif %}

            <span class="current" style="font-size: 0.75rem;">
                Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
            </span>

            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}" style="font-size: 0.75rem;">다음</a>
                <a href="?page={{ page_obj.paginator.num_pages }}" style="font-size: 0.75rem;">마지막 &raquo;</a>
            {% endif %}
        </span>
      </div>
    </div>
  </div>
</div>

<script>
  var HOME_PATH = "{% static 'image' %}";
  var map = new naver.maps.Map("map", {
        center: new naver.maps.LatLng(36.5823435, 127.1250753),
        zoom: 10,
    });

  var locations = [
      {% for instance in object_list %}
        {
          latitude: {{ instance.report.latitude }},
          longitude: {{ instance.report.longitude }},
          priority: "{{ instance.priority }}",  // 문자열로 감쌈
          link_id: "{{ instance.link_id }}",  // 문자열로 감쌈
          type: "{{ instance.type }}",  // 문자열로 감쌈
          traffic: "{{ instance.traffic }}",  // 문자열로 감쌈
          date: "{{ instance.date }}",  // 문자열로 감쌈
        },
      {% endfor %}
    ];

  locations.forEach(function(location){

    var icornUrl;
    if (location.priority === "1") {
      icornUrl = HOME_PATH + '/warning1.png';
    } else if (location.priority === "2") {
      icornUrl = HOME_PATH + '/caution1.png';
    } else {
      icornUrl = HOME_PATH + '/intend1.png';
    }

    var marker = new naver.maps.Marker({
        position: new naver.maps.LatLng(location.latitude, location.longitude),
        map: map,
        icon: {
            url: icornUrl,
            size: new naver.maps.Size(35, 40),
            scaledSize: new naver.maps.Size(35, 40),
        },
        title: "우선순위: " + location.priority + "링크ID: "+ location.link_id
    })

    var infoWindow = new naver.maps.InfoWindow({
          content: '<div style="padding:10px;">' +
                    '<strong>우선순위:</strong> ' + location.priority + '<br>' +
                    '<strong>링크ID:</strong> ' + location.link_id + '<br>' +
                    '<strong>균열 타입:</strong> ' + location.type + '<br>' +
                    '<strong>교통량:</strong> ' + location.traffic + '<br>' +
                    '<strong>등록일자:</strong> ' + location.date +
                    '</div>'
      });

      // 마커 클릭 시 정보 창 열기
      naver.maps.Event.addListener(marker, "click", function() {
        if(infoWindow.getMap()) {
          infoWindow.close();
        }  else {
          infoWindow.open(map, marker);
        }
      });

    document.querySelectorAll('.priority-link').forEach(function(link) {
      link.addEventListener('click', function(event) {
          event.preventDefault(); // 기본 링크 동작 방지
          var lat = parseFloat(link.getAttribute('data-lat'));
          var lng = parseFloat(link.getAttribute('data-lng'));
          console.log(lat, lng);
          // 지도 중심을 마커 위치로 이동하고 줌 레벨 변경
          map.setCenter(new naver.maps.LatLng(lat, lng));
          map.setZoom(16); // 원하는 줌 레벨로 설정
      });
    });
  });
</script>
{% endblock %}